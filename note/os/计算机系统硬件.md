## 计算机系统硬件

操作系统是一直运行在计算机上的程序（内核kernel），此外还有 **系统程序** 和 **应用程序** 两类程序。

### 计算机体系结构

#### 图灵机

图灵的基本思想是用机器来模拟人们用纸笔进行数学运算的过程，而且还定义了计算机由哪些部分组成，程序又是如何执行的。

图灵机有一条 **纸带** （相当于内存）被划分为一个个大小相等小方格，每个方格存放一个符号（数字、字母或其他符号，相当于存在内存中的数据或程序）。**读写头** 可以读取纸带上任意格子的字符，读写头的存储单元用于存放数据；控制单元用于识别字符是数据还是指令，控制程序流程等；运算单元用于执行运算指令。

#### 冯诺依曼结构

冯诺依曼体系结构定义计算机的基本结构为：运算器、控制器、存储器、输入设备和输出设备。

指令执行过程：首先从内存中获取指令，并存到指令寄存器中；指令被解码，或者从内存中获取操作数据并存到内部寄存器；指令完成对操作数据的执行，结果存到内存。

#### CPU

CPU的位数是指运算器一次执行指令的数据带宽，32位CPU一次可以计算4个字节数据，64位CPU一次可以计算8个字节数据。**总线** 用于CPU和内存以及其他设备之间的通信。总线分为三种：

-   地址总线：指定CPU要操作的内存地址；
-   数据总线：读写内存的数据；
-   控制总线：控制读写命令。

数据传输用控制电压在总线上传输，低电压为0，高电压为1。一条地址总线只表示0\1两种情况，即访问2个内存地址，4G则需要32位（2^32=4G）。因此CPU位宽最好与总线位宽相同。

CPU内部组件：寄存器、高速缓存、控制单元和逻辑运算单元。

-   **寄存器**：用于存储计算时的数据，最靠近CPU控制单元和逻辑计算单元的存储器。
    
    -   通用寄存器：存放运算数据；
    -   程序计数器：存储CPU要执行下一条指令的内存地址；
    -   指令寄存器：存放程序计数器指向的指令。
    
-   **CPU Cache**：高速缓存，使用SRAM（静态随机存储器）芯片，通常分为L1、L2、L3三层高速缓存。

    -   一级缓存：数据缓存和指令缓存，每个CPU核心都有一块L1高速缓存，指令和数据分开存放。访问速度几乎和寄存器一样快，通常需要2-4个时钟周期，大小在几十KB到几百KB不等；

        ```shell
        # 数据缓存
        $ cat /sys/devices/system/cpu/cpu0/cache/index0/size
        # 指令缓存
        $ cat /sys/devices/system/cpu/cpu0/cache/index1/size
        ```

    -   二级缓存：每个CPU核心都有，访问速度10-20个时钟周期；
        ```shell
        $ cat /sys/devices/system/cpu/cpu0/cache/index2/size
        ```

    -   三级缓存：多个CPU核心公用，大小在几MB到几十MB。

CPU读取数据时，先访问Cache，只有当Cache找不到数据时才会访问内存。CPU Cache的数据是一块一块的从内存中读取的，称为缓存块（Cache Line）。

#### 内存

内存用来存储需要执行的程序和数据，其最小存储单位是 **字节byte**。每个字节对应一个内存地址，内存地址从0开始自增排列。

内存使用DRAM（动态随机存取存储器）芯片。

每一种存储设备只会与相邻一层存储器设备交互，例如CPU Cache的数据是从内存加载的，写回数据也只会写到内存中，而不会直接把数据写到硬盘，也不会直接从硬盘加载数据。

### 程序的执行过程

在冯诺依曼体系结构下，程序实际位一条一条的指令，由CPU执行，执行过程如下：

1.   CPU读取 **程序计数器PC** 的值（指令的内存地址），然后CPU的 **控制单元** 操作  **地址总线** 指定访问的内存地址，通知内存设备准备数据，然后通过地址总线将指令数据传回给CPU，CPU收到数据后存入 **指令寄存器**。
2.   CPU分析 **指令寄存器** 中的指令，确定指令类型和参数。如果是计算类型的指令，就交给 **逻辑运算单元** 运算；如果是存储类型的指令，则交给 **控制单元** 执行。
3.   CPU执行完指令，**程序计数器** 值自增，表示指向下一条指令。自增大小由CPU位宽决定。

#### 指令执行速度

程序执行耗费的CPU时间就是程序的执行时间，可以分为 **CPU时钟周期数** 和 **时钟周期时间** 的乘积。时钟周期时间时CPU主频，主频越高说明CPU的工作速度越快。CPU时钟周期数为 **指令数** 和 **每条指令平均时钟周期（CPI）** 的乘积，指令数为程序有多少条指令，CPI表示一条指令需要多少个时钟周期数。