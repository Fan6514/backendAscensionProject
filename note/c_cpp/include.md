## 预处理器使用指南

C/C++ 文件编译文件的过程包括：预处理、编译、链接。其中**预处理器** 不是编译器的组成部分，但是它是编译过程中一个单独的步骤。简言之，C 预处理器只不过是一个**文本替换工具**而已，它们会指示编译器在实际编译之前完成所需的预处理。我们将把 C 预处理器（C Preprocessor）简写为 CPP。 

所有的预处理命令都必须以 # 开头，它必须是第一个非空字符，为了增强可读性，预处理器指令应从第一列开始。 预处理器指令的末尾不含分号。 C/C++ 提供的预处理功能主要包括文件包含、宏替换、条件编译等。

###  预处理指令

**1. 预定义的符号**

-   **FILE** -  代表进行编译的源文件名
-   **LINE** -  文件当前的行号
-   **DATE** -  文件被编译的日期 
-   **TIME** - 文件被编译的时间
-   **STDC** -  编译器遵循 ANSI C 其值为1，否则未定义

在 .c 文件中使用时要在前后分别增加两个下划线：

```c
/* preprocessor.c */
#include <stdio.h>

int main()
{
    printf("[INFO] %d-%d %s:%d", __DATE__, __TIME__, __FILE__, __LINE__);
    return 0;
}
```

输出的结果为：

```shell
[INFO] 4218972-4218963 preprocessor.c:6
```

**2. ## 运算符**

`##` 运算符可用于带参数的函数宏，将两个 Token 合并为一个新的 Token， 可以提高封装性及程序的可读性。例如：

```c
#define CMD_PROCESS(index, cmd) {index, cmdFunc##_line}
```

上面的宏在使用时可以展开为如下：

```c
CMD_PROCCESS(0, show)
{0, show_line}
```

**3. #define**

  使用#define指令，你可以把任何文本替换到程序里面，通常把这种实现称为**宏**或者**定义宏**。用预处理指令 #define 声明一个常数，用以表明1年中有多少秒（忽略闰年问题） 

```c
#define SEC_YEAR  (365*24*60*60)UL
```

预处理器首先会帮你**计算出常数表达式的值**，这样写更为清晰而没有代价；由于这个表达式将使一个16位机的整型数溢出，因此要用到长整型符号 L，告诉编译器这个常数是的长整型数；使用 UL   表示无符号长整型 。

**4. #error**

 编译程序时，只要遇到 #error 就会跳出一个编译错误，既然是编译错误，要它干嘛呢？其目的就是保证程序是按照你所设想的那样进行编译的。 

 程序中往往有很多的预处理指令，当程序比较大时，往往有些宏定义是在外部指定的（如makefile），或是在系统头文件中指定的，当你不太确定当前是否定义了 xxx 时，就可以改成如下这样进行编译：

```c
#ifdef xxx
...
#error "xxx has been defined"
#else
...
#endif
```

 这样，如果编译时出现错误，输出了`xxx has been defined`，表明宏`xxx`已经被定义了。 

### 消除宏副作用

宏只是一种定义，他定义了一个语句块，当程序编译时，编译器首先要执行一个“替换”源程序的动作，把宏引用的地方替换成宏定义的语句块，就像文本文件替换一样。这个动作术语叫“宏的展开”。

 使用宏是比较“危险”的，因为你不知道宏展开后会是什么一个样子。 因此在写宏时要非常谨慎，避免在使用中产生副作用。

写一个"标准"宏MIN ，这个宏输入两个参数并返回较小的一个。 

```c
#define MIN(a,b)  ((a)<=(b)?(a):(b))
```

宏函数是 C 语言中经常使用的表达方式，用来封装一些实现较短的功能， 为了能达到要求的性能，嵌入代码经常是必须的方法。  在宏中要小心地把参数用括号括起来，以免产生副作用。

此外，对应一些能产生副作用的操作，如自增、自减等传入宏函数之后，也可能产生副作用。如：

```c
MIN(*p++, 1);
```

调用上述宏函数的后果可能会导致指针向后偏移两位。

宏函数最好使用 do-while 语句进行封装，如下宏函数封装了一个申请内存的函数：

```c
#define GET_MEMORY_RTN(ptr, type, size)\
do\
{\
    ptr = (type*)malloc(size);\
    if (NULL == ptr)\
    {\
        LOG_ERROR("Malloc error.");\
        return MEM_ERROR;\
    }\
    memset(ptr, 0, size);\
}while(0)
```

**不要在宏定义中加分号**，哪怕是定义了一个语句：

```c
#define LINE "================================="
#define PRINT_LINE printf(LINE)
#define PRINT_NLINE(n) while ( n-- >0 ) { PRINT_LINE; }
```

正确的做法是在调用时加上分号：

```c
main()
{
	char *p = LINE;
	PRINT_LINE;
}
```
